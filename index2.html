<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¢è‰²å¾é€” - æ²‰æµ¸å¼å‰§æœ¬æ€æ¼”ç¤º</title>
    <!-- 1. å¼•å…¥ Tailwind CSS (æ ·å¼åº“) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. å¼•å…¥ React å’Œ ReactDOM (æ ¸å¿ƒåº“) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 3. å¼•å…¥ Babel (ç”¨äºç¿»è¯‘ React ä»£ç ) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* è‡ªå®šä¹‰åŠ¨ç”»æ ·å¼ */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fade-in 0.5s ease-out forwards; }
        .text-shadow-sm { text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-stone-100">
    <!-- React åº”ç”¨æŒ‚è½½ç‚¹ -->
    <div id="root"></div>

    <!-- React ä¸šåŠ¡ä»£ç  -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 0. å›¾æ ‡æ›¿ä»£æ–¹æ¡ˆ (ä¸ºäº†å•æ–‡ä»¶è¿è¡Œï¼Œä½¿ç”¨ SVG æ›¿ä»£ lucide-react åº“) ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Star = ({ size, className, fill }) => <IconBase className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill={fill || "none"} /></IconBase>;
        const User = ({ size, className }) => <IconBase className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></IconBase>;
        const MapIcon = ({ size, className }) => <IconBase className={className}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></IconBase>;
        const Package = ({ size, className }) => <IconBase className={className}><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></IconBase>;
        const MessageSquare = ({ size, className }) => <IconBase className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></IconBase>;
        const Scan = ({ size, className }) => <IconBase className={className}><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path></IconBase>;
        const ChevronRight = ({ size, className }) => <IconBase className={className}><polyline points="9 18 15 12 9 6"></polyline></IconBase>;
        const Aperture = ({ size, className }) => <IconBase className={className}><circle cx="12" cy="12" r="10"></circle><line x1="14.31" y1="8" x2="20.05" y2="17.94"></line><line x1="9.69" y1="8" x2="21.17" y2="8"></line><line x1="7.38" y1="12" x2="13.12" y2="2.06"></line><line x1="9.69" y1="16" x2="3.95" y2="6.06"></line><line x1="14.31" y1="16" x2="2.83" y2="16"></line><line x1="16.62" y1="12" x2="10.88" y2="21.94"></line></IconBase>;
        const Volume2 = ({ size, className }) => <IconBase className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></IconBase>;


        // --- 1. æ¨¡æ‹Ÿæ•°æ®ä¸å‰§æœ¬é…ç½® (Mock Data) ---

        const SCRIPT_DATA = {
            scenario_id: "red_storm_1949",
            title: "é»æ˜å‰çš„æš—å·",
            roles: [
                { id: "scout", name: "ä¾¦å¯Ÿå…µ", desc: "æ•æ·æœºæ™ºï¼Œè´Ÿè´£æƒ…æŠ¥æœé›†", icon: "ğŸ”­" },
                { id: "medic", name: "å«ç”Ÿå‘˜", desc: "æ•‘æ­»æ‰¶ä¼¤ï¼Œè´Ÿè´£åå‹¤ä¿éšœ", icon: "âš•ï¸" }
            ],
            stages: [
                {
                    stage_id: 101,
                    name: "æ‘å£æƒ…æŠ¥ç«™",
                    coordinates: { x: 20, y: 70 },
                    is_unlocked: true,
                    pre_narrative: [
                        { type: "MONOLOGUE", content: "1949å¹´ï¼Œé‡åº†ã€‚é›¾æ°”å¼¥æ¼«åœ¨å±±åŸï¼Œä½ ç´§äº†ç´§èº«ä¸Šçš„ç ´æ£‰è¢„ï¼Œæ‰‹é‡Œæ”¥ç€åŠå¼ å‘é»„çš„æ—§æŠ¥çº¸ã€‚", bg_color: "black" },
                        { type: "DIALOGUE", speaker: "ç‹å¤§å¨˜", avatar: "ğŸ‘µ", content: "åŒå¿—ï¼ä½ å¯ç®—æ¥äº†ã€‚æ‘å£çš„ç¢‰å ¡æœ€è¿‘ç›˜æŸ¥å¾—ç´§ï¼Œåªæœ‰å¯¹ä¸Šæš—å·æ‰èƒ½è¿‡å»ã€‚", bg_color: "scene" }
                    ],
                    task: {
                        type: "PHOTO_AI",
                        target: "bunker",
                        desc: "å¯»æ‰¾å¹¶æ‹æ‘„æ•Œå†›ç¢‰å ¡çš„ç«åŠ›ç‚¹é…ç½®",
                        hint: "è”ç»œå‘˜æç¤ºï¼šç¢‰å ¡é€šå¸¸ä½äºé«˜å¤„ï¼Œæ³¨æ„è§‚å¯Ÿç­æœ›å­”ã€‚",
                        success_msg: "æƒ…æŠ¥å·²è·å–ï¼ç«åŠ›ç‚¹åˆ†å¸ƒå›¾å·²ç”Ÿæˆã€‚"
                    },
                    post_narrative: [
                        { type: "DIALOGUE", speaker: "è”ç»œå‘˜", avatar: "ğŸ‘®", content: "å¹²å¾—å¥½ï¼æœ‰äº†è¿™å¼ å›¾ï¼Œçªå‡»é˜Ÿä»Šæ™šå°±èƒ½è¡ŒåŠ¨äº†ã€‚è¿™æ˜¯ç»™ä½ çš„å·¥åˆ†å¥–åŠ±ã€‚", bg_color: "scene" },
                        { type: "REWARD", item: { id: "ticket_food", name: "ç²®ç¥¨(5æ–¤)", type: "ticket" }, points: 10 }
                    ]
                },
                {
                    stage_id: 102,
                    name: "ç§˜å¯†äº¤é€šç«™",
                    coordinates: { x: 50, y: 40 },
                    is_unlocked: false,
                    pre_narrative: [
                        { type: "DIALOGUE", speaker: "è”ç»œå‘˜", avatar: "ğŸ‘®", content: "å¿«ï¼æŠŠæƒ…æŠ¥é€åˆ°äº¤é€šç«™çš„è€ææ‰‹é‡Œã€‚ä»–åœ¨èŒ¶é¦†ç­‰ç€ã€‚", bg_color: "scene" }
                    ],
                    task: {
                        type: "QUIZ",
                        question: "æ¥å¤´æš—å·ï¼šé•¿æ±Ÿé•¿æ±Ÿï¼Œæˆ‘æ˜¯é»„æ²³ã€‚ä¸‹ä¸€å¥æ˜¯ï¼Ÿ",
                        options: ["åœ°ç“œåœ°ç“œï¼Œæˆ‘æ˜¯åœŸè±†", "é«˜å±±æµæ°´ï¼ŒçŸ¥éŸ³éš¾è§…", "ä¸‡é‡Œé•¿åŸï¼Œæ°¸ä¸å€’"],
                        answer: 0,
                        desc: "å›ç­”è€æçš„æš—å·éªŒè¯èº«ä»½"
                    },
                    post_narrative: [
                        { type: "DIALOGUE", speaker: "è€æ", avatar: "ğŸ‘´", content: "åŒå¿—ï¼Œè¾›è‹¦äº†ï¼ç»„ç»‡ä¸Šç»™ä½ è®°ä¸€åŠŸã€‚", bg_color: "scene" },
                        { type: "REWARD", item: { id: "medal_star", name: "çº¢æ˜Ÿå‹‹ç« ", type: "medal" }, points: 50 }
                    ]
                },
                {
                    stage_id: 103,
                    name: "èƒœåˆ©ä¼šå¸ˆ",
                    coordinates: { x: 80, y: 20 },
                    is_unlocked: false,
                    pre_narrative: [{ type: "MONOLOGUE", content: "å†²é”‹å·å¹å“äº†ï¼Œçº¢æ——æ’éäº†å±±å¤´ï¼", bg_color: "red" }],
                    task: { type: "CHECK_IN", desc: "æŠµè¾¾ç»ˆç‚¹ï¼Œå®Œæˆä¼šå¸ˆ" },
                    post_narrative: [{ type: "ENDING", content: "ä»»åŠ¡å®Œæˆï¼ä½ è§è¯äº†å†å²ã€‚", bg_color: "gold" }]
                }
            ]
        };

        // --- 2. åŸºç¡€ç»„ä»¶ (Components) ---

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
            const baseStyle = "px-4 py-2 rounded font-bold shadow-md transition-all active:scale-95 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-red-800 text-yellow-100 border-2 border-yellow-600 hover:bg-red-900",
                secondary: "bg-stone-600 text-white border-2 border-stone-400 hover:bg-stone-700",
                outline: "bg-transparent text-red-900 border-2 border-red-900 hover:bg-red-50",
                gold: "bg-yellow-600 text-red-900 border-2 border-red-900 hover:bg-yellow-500"
            };
            
            return (
                <button 
                onClick={onClick} 
                disabled={disabled}
                className={`${baseStyle} ${variants[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}
                >
                {children}
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
                <div className="bg-[#fdfbf7] w-full max-w-sm rounded-lg border-4 border-red-900 shadow-2xl overflow-hidden animate-in">
                    <div className="bg-red-900 text-yellow-100 p-3 flex justify-between items-center border-b-2 border-yellow-600">
                    <h3 className="font-bold text-lg tracking-widest">{title}</h3>
                    <button onClick={onClose} className="text-yellow-200 hover:text-white">âœ•</button>
                    </div>
                    <div className="p-4 max-h-[70vh] overflow-y-auto">
                    {children}
                    </div>
                </div>
                </div>
            );
        };

        // --- 3. ä¸šåŠ¡æ¨¡å—ç»„ä»¶ (Modules) ---

        const MapView = ({ stages, currentPos, onStageClick, teamMembers }) => {
            return (
                <div className="relative w-full h-full bg-[#e6dfcc] overflow-hidden">
                {/* æ¨¡æ‹Ÿåœ°å›¾èƒŒæ™¯å›¾ */}
                <div 
                    className="absolute inset-0 opacity-20 pointer-events-none"
                    style={{
                    backgroundImage: `repeating-linear-gradient(0deg, transparent, transparent 19px, #d6cfbc 20px), repeating-linear-gradient(90deg, transparent, transparent 19px, #d6cfbc 20px)`,
                    backgroundSize: '20px 20px'
                    }} 
                />
                <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                    <MapIcon size={200} className="text-red-900" />
                </div>

                {/* è·¯çº¿è¿æ¥çº¿ */}
                <svg className="absolute inset-0 w-full h-full pointer-events-none">
                    <path 
                    d={`M ${stages[0].coordinates.x}% ${stages[0].coordinates.y}% L ${stages[1].coordinates.x}% ${stages[1].coordinates.y}% L ${stages[2].coordinates.x}% ${stages[2].coordinates.y}%`}
                    fill="none"
                    stroke="#8B0000"
                    strokeWidth="3"
                    strokeDasharray="5,5"
                    />
                </svg>

                {/* å…³å¡ç‚¹ä½ (POI) */}
                {stages.map((stage) => (
                    <button
                    key={stage.stage_id}
                    onClick={() => onStageClick(stage)}
                    className={`absolute transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center group transition-all duration-300 ${stage.is_unlocked ? 'scale-100' : 'scale-75 opacity-60 grayscale'}`}
                    style={{ left: `${stage.coordinates.x}%`, top: `${stage.coordinates.y}%` }}
                    >
                    <div className={`w-12 h-12 rounded-full border-4 flex items-center justify-center shadow-lg ${stage.is_unlocked ? 'bg-red-800 border-yellow-500 animate-bounce' : 'bg-stone-500 border-stone-300'}`}>
                        <Star className={`${stage.is_unlocked ? 'text-yellow-400' : 'text-stone-300'}`} fill="currentColor" size={24} />
                    </div>
                    <span className="mt-1 bg-white/90 px-2 py-0.5 text-xs font-bold text-red-900 rounded border border-red-900 shadow-sm whitespace-nowrap">
                        {stage.name}
                    </span>
                    </button>
                ))}

                {/* ç©å®¶å½“å‰ä½ç½® (LBS Mock) */}
                <div 
                    className="absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-1000 ease-in-out"
                    style={{ left: `${currentPos.x}%`, top: `${currentPos.y}%` }}
                >
                    <div className="relative">
                    <div className="w-10 h-10 bg-blue-600 rounded-full border-2 border-white shadow-xl flex items-center justify-center z-10">
                        <User className="text-white" size={20} />
                    </div>
                    <div className="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-3 h-1.5 bg-black/30 rounded-full blur-[2px]" />
                    <div className="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-blue-800 text-white text-[10px] px-1.5 py-0.5 rounded whitespace-nowrap">
                        æˆ‘ (ä¾¦å¯Ÿå…µ)
                    </div>
                    </div>
                </div>

                {/* é˜Ÿå‹ä½ç½® (Websocket Mock) */}
                {teamMembers.map((member, idx) => (
                    <div 
                    key={idx}
                    className="absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-700 ease-linear"
                    style={{ left: `${member.x}%`, top: `${member.y}%` }}
                    >
                    <div className="w-8 h-8 bg-green-700 rounded-full border-2 border-white shadow-md flex items-center justify-center opacity-80">
                        <span className="text-white text-xs font-bold">{member.name[0]}</span>
                    </div>
                    </div>
                ))}

                {/* HUD è¦†ç›–å±‚ */}
                <div className="absolute top-4 left-4 right-4 flex justify-between items-start pointer-events-none">
                    <div className="bg-white/90 backdrop-blur border-l-4 border-red-800 p-2 shadow-md rounded-r-md pointer-events-auto">
                    <div className="text-xs text-gray-500 font-serif">å½“å‰ä»»åŠ¡</div>
                    <div className="text-sm font-bold text-red-900">å‰å¾€ï¼š{stages.find(s=>s.is_unlocked && !s.completed)?.name || "ä»»åŠ¡å®Œæˆ"}</div>
                    </div>
                    <div className="flex flex-col gap-2 pointer-events-auto">
                    <button className="bg-yellow-500 p-2 rounded-full shadow-lg border-2 border-red-900 text-red-900">
                        <Scan size={20} />
                    </button>
                    </div>
                </div>
                </div>
            );
        };

        const NarrativePlayer = ({ script, onComplete }) => {
            const [index, setIndex] = useState(0);
            const currentLine = script[index];

            const handleNext = () => {
                if (index < script.length - 1) {
                setIndex(index + 1);
                } else {
                onComplete();
                }
            };

            // ç‹¬ç™½æ¨¡å¼
            if (currentLine.type === "MONOLOGUE") {
                return (
                <div className={`fixed inset-0 z-50 flex flex-col items-center justify-center p-8 text-center animate-in ${currentLine.bg_color === 'red' ? 'bg-red-900' : 'bg-black'} text-white`}>
                    <div className="max-w-md space-y-6">
                    <p className="text-xl leading-relaxed font-serif tracking-widest opacity-90">{currentLine.content}</p>
                    <Button variant="outline" className="border-white text-white hover:bg-white/20 mx-auto" onClick={handleNext}>
                        ç»§ç»­ <ChevronRight size={16} />
                    </Button>
                    </div>
                </div>
                );
            }

            // ç»“å±€æ¨¡å¼
            if (currentLine.type === "ENDING") {
                return (
                <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-red-800 text-yellow-300 p-8 text-center animate-in">
                    <Star size={80} fill="currentColor" className="animate-pulse mb-6" />
                    <h1 className="text-4xl font-bold mb-4">ä»»åŠ¡åœ†æ»¡å®Œæˆ</h1>
                    <p className="text-xl opacity-90 mb-8">{currentLine.content}</p>
                    <Button variant="gold" onClick={handleNext}>è¿”å›é¦–é¡µ</Button>
                </div>
                );
            }

            // å¯¹è¯/å¥–åŠ±æ¨¡å¼
            return (
                <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/60 backdrop-blur-sm">
                <div className="w-full max-w-lg bg-[#fdfbf7] border-t-4 border-red-900 p-6 pb-12 shadow-2xl animate-in relative">
                    {/* è§’è‰²ç«‹ç»˜å ä½ */}
                    {currentLine.avatar && (
                    <div className="absolute -top-16 left-6 w-20 h-20 bg-stone-300 rounded-full border-4 border-[#fdfbf7] flex items-center justify-center text-4xl shadow-md">
                        {currentLine.avatar}
                    </div>
                    )}
                    
                    <div className="mt-4 space-y-3">
                    {currentLine.speaker && (
                        <div className="font-bold text-red-900 text-lg flex items-center gap-2">
                        {currentLine.speaker}
                        <span className="text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded-full font-normal">NPC</span>
                        </div>
                    )}
                    
                    <div className="min-h-[80px] text-lg text-stone-800 font-serif leading-relaxed">
                        {currentLine.content || `è·å¾—å¥–åŠ±: ${currentLine.item?.name} (+${currentLine.points}å·¥åˆ†)`}
                    </div>

                    <div className="flex justify-end pt-2">
                        <Button onClick={handleNext}>
                        {index === script.length - 1 ? (currentLine.type === 'REWARD' ? 'æ”¶å…¥èƒŒå›Š' : 'æ¥å—ä»»åŠ¡') : 'ä¸‹ä¸€æ­¥'}
                        </Button>
                    </div>
                    </div>
                </div>
                </div>
            );
        };

        const TaskModule = ({ task, onTaskComplete }) => {
            const [isScanning, setIsScanning] = useState(false);
            const [showHint, setShowHint] = useState(false);

            // æ¨¡æ‹ŸAIæ‹ç…§
            const handleCamera = () => {
                setIsScanning(true);
                setTimeout(() => {
                setIsScanning(false);
                onTaskComplete(true); // æˆåŠŸ
                }, 2500);
            };

            // ç­”é¢˜å¤„ç†
            const handleQuiz = (index) => {
                if (index === task.answer) {
                onTaskComplete(true);
                } else {
                alert("æš—å·é”™è¯¯ï¼è¯·é‡è¯•ã€‚");
                }
            };

            if (task.type === "PHOTO_AI") {
                return (
                <div className="fixed inset-0 z-40 bg-black flex flex-col">
                    {/* ç›¸æœºå–æ™¯æ¡† */}
                    <div className="flex-1 relative bg-stone-900 flex items-center justify-center overflow-hidden">
                    {isScanning && (
                        <div className="absolute inset-0 bg-green-500/20 z-10 animate-pulse flex items-center justify-center">
                        <div className="text-green-400 font-mono text-xl font-bold bg-black/50 p-2">æ­£åœ¨åˆ†æç‰¹å¾å€¼...</div>
                        </div>
                    )}
                    <img 
                        src="https://placehold.co/400x600/333/999?text=Camera+View" 
                        alt="Viewfinder" 
                        className="w-full h-full object-cover opacity-50"
                    />
                    <div className="absolute inset-10 border-2 border-white/50 corner-borders flex flex-col justify-between p-4">
                        <div className="text-white/80 font-mono text-xs">AI_VISION_V2.0 // TARGET: {task.target}</div>
                        <div className="text-center text-white font-bold drop-shadow-md">{task.desc}</div>
                    </div>
                    </div>

                    {/* åº•éƒ¨æ“ä½œæ  */}
                    <div className="h-48 bg-black text-white p-6 flex flex-col items-center gap-4">
                    {showHint && (
                        <div className="w-full bg-stone-800 p-3 rounded text-sm text-yellow-200 border border-yellow-600/30 animate-in">
                        {task.hint}
                        </div>
                    )}
                    <div className="flex items-center gap-8 w-full justify-center">
                        <button onClick={() => setShowHint(!showHint)} className="flex flex-col items-center gap-1 text-stone-400 hover:text-white">
                            <div className="p-3 rounded-full bg-stone-800"><MessageSquare size={20}/></div>
                            <span className="text-xs">è”ç»œå‘˜</span>
                        </button>

                        <button 
                        onClick={handleCamera}
                        className="w-16 h-16 rounded-full border-4 border-white flex items-center justify-center bg-red-600 active:bg-red-700 transition-colors shadow-[0_0_20px_rgba(255,0,0,0.5)]"
                        >
                        <Aperture size={32} />
                        </button>

                        <button className="flex flex-col items-center gap-1 text-stone-400 hover:text-white opacity-50 cursor-not-allowed">
                            <div className="p-3 rounded-full bg-stone-800"><Volume2 size={20}/></div>
                            <span className="text-xs">é—ªå…‰ç¯</span>
                        </button>
                    </div>
                    </div>
                </div>
                );
            }

            if (task.type === "QUIZ") {
                return (
                <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/80 backdrop-blur p-4">
                    <div className="bg-[#fdfbf7] w-full max-w-md rounded p-6 shadow-2xl border-t-8 border-red-900">
                        <h3 className="text-xl font-bold text-red-900 mb-2">èº«ä»½éªŒè¯</h3>
                        <p className="text-stone-600 mb-6 font-serif text-lg">{task.question}</p>
                        <div className="space-y-3">
                        {task.options.map((opt, idx) => (
                            <button 
                            key={idx}
                            onClick={() => handleQuiz(idx)}
                            className="w-full text-left p-4 rounded border-2 border-stone-300 hover:border-red-800 hover:bg-red-50 transition-colors font-medium text-stone-800"
                            >
                            {String.fromCharCode(65 + idx)}. {opt}
                            </button>
                        ))}
                        </div>
                    </div>
                </div>
                )
            }

            return null;
        };

        // --- 4. ä¸»åº”ç”¨é€»è¾‘ (Main App) ---

        function RedJourneyApp() {
            const [view, setView] = useState('LOGIN');
            const [userRole, setUserRole] = useState(null);
            const [stages, setStages] = useState(SCRIPT_DATA.stages);
            const [activeStage, setActiveStage] = useState(null);
            const [narrativeQueue, setNarrativeQueue] = useState(null);
            const [currentTask, setCurrentTask] = useState(null);
            
            const [inventory, setInventory] = useState([]);
            const [points, setPoints] = useState(0);
            const [currentPos, setCurrentPos] = useState({ x: 50, y: 90 });
            const [teamMembers, setTeamMembers] = useState([
                { name: "å¼ ä¸‰", x: 45, y: 88 },
                { name: "æå››", x: 55, y: 92 }
            ]);

            useEffect(() => {
                const interval = setInterval(() => {
                setTeamMembers(prev => prev.map(m => ({
                    ...m,
                    x: m.x + (Math.random() - 0.5) * 2,
                    y: m.y + (Math.random() - 0.5) * 2
                })));
                }, 2000);
                return () => clearInterval(interval);
            }, []);

            const handleStageClick = (stage) => {
                if (!stage.is_unlocked) {
                alert("è¯¥åŒºåŸŸå°šæœªè§£é”ï¼è¯·å…ˆå®Œæˆå‰åºä»»åŠ¡ã€‚");
                return;
                }
                
                setCurrentPos(stage.coordinates);
                setActiveStage(stage);

                if (stage.completed) {
                alert("è¯¥ç‚¹ä½ä»»åŠ¡å·²å®Œæˆã€‚");
                return;
                }

                if (stage.pre_narrative) {
                setNarrativeQueue({ type: 'PRE', content: stage.pre_narrative, stageId: stage.stage_id });
                } else {
                startTask(stage);
                }
            };

            const startTask = (stage) => {
                if (stage.task) {
                setCurrentTask({ ...stage.task, stageId: stage.stage_id });
                } else {
                handleTaskComplete(true, stage);
                }
            };

            const handleNarrativeComplete = () => {
                const queueType = narrativeQueue.type;
                const stage = stages.find(s => s.stage_id === narrativeQueue.stageId);
                setNarrativeQueue(null);

                if (queueType === 'PRE') {
                startTask(stage);
                } else if (queueType === 'POST') {
                const nextStageId = stage.stage_id + 1;
                setStages(prev => prev.map(s => {
                    if (s.stage_id === stage.stage_id) return { ...s, completed: true };
                    if (s.stage_id === nextStageId) return { ...s, is_unlocked: true };
                    return s;
                }));
                setActiveStage(null);
                }
            };

            const handleTaskComplete = (success) => {
                if (success) {
                setCurrentTask(null);
                const stage = activeStage;
                if (stage.post_narrative) {
                    setNarrativeQueue({ type: 'POST', content: stage.post_narrative, stageId: stage.stage_id });
                    
                    const rewards = stage.post_narrative.filter(n => n.type === 'REWARD');
                    rewards.forEach(r => {
                    setInventory(prev => [...prev, r.item]);
                    setPoints(p => p + r.points);
                    });
                }
                }
            };

            if (view === 'LOGIN') {
                return (
                <div className="h-screen w-full bg-[#8B0000] flex flex-col items-center justify-center p-6 text-yellow-100 relative overflow-hidden">
                    <div className="z-10 text-center space-y-8 animate-in">
                    <div className="mb-8">
                        <div className="inline-block border-4 border-yellow-500 p-4 rounded-full mb-4 bg-red-900 shadow-xl">
                        <Star size={64} fill="#FFD700" className="text-yellow-500 animate-pulse"/>
                        </div>
                        <h1 className="text-4xl font-bold tracking-widest text-shadow-sm font-serif">çº¢è‰²å¾é€”</h1>
                        <p className="mt-2 text-yellow-200/80 tracking-wider">æ²‰æµ¸å¼å®æ™¯å‰§æœ¬æ€ç³»ç»Ÿ V4.0</p>
                    </div>

                    <div className="bg-red-900/50 p-6 rounded-lg backdrop-blur-sm border border-yellow-600/30 w-full max-w-xs mx-auto">
                        <h2 className="text-lg font-bold mb-4 border-b border-yellow-600/30 pb-2">è¯·é€‰æ‹©ä½ çš„è§’è‰²</h2>
                        <div className="space-y-3">
                        {SCRIPT_DATA.roles.map(role => (
                            <button 
                            key={role.id}
                            onClick={() => setUserRole(role)}
                            className={`w-full p-3 rounded flex items-center gap-3 transition-all ${userRole?.id === role.id ? 'bg-yellow-600 text-red-900 shadow-lg scale-105' : 'bg-red-950/50 hover:bg-red-800'}`}
                            >
                            <span className="text-2xl">{role.icon}</span>
                            <div className="text-left">
                                <div className="font-bold">{role.name}</div>
                                <div className="text-xs opacity-70">{role.desc}</div>
                            </div>
                            </button>
                        ))}
                        </div>
                    </div>

                    <Button 
                        variant="gold" 
                        className="w-full max-w-xs py-3 text-lg shadow-xl"
                        disabled={!userRole}
                        onClick={() => setView('HOME')}
                    >
                        {userRole ? 'é¢†å–ä»»åŠ¡ä¹¦ï¼Œå‡ºå‘ï¼' : 'è¯·å…ˆé€‰æ‹©è§’è‰²'}
                    </Button>
                    </div>
                    
                    <div className="absolute bottom-4 text-xs text-yellow-100/30">
                    Powered by æä½³å£• V4.0 System
                    </div>
                </div>
                );
            }

            return (
                <div className="h-screen w-full flex flex-col bg-[#e6dfcc] font-sans text-stone-800 relative overflow-hidden">
                <div className="bg-red-900 text-yellow-100 p-3 shadow-md flex justify-between items-center z-20">
                    <div className="flex items-center gap-2">
                    <div className="w-8 h-8 rounded-full bg-yellow-600 flex items-center justify-center text-red-900 font-bold border border-yellow-400">
                        {userRole.name[0]}
                    </div>
                    <div className="flex flex-col leading-none">
                        <span className="text-sm font-bold">{userRole.name}</span>
                        <span className="text-[10px] text-yellow-200 opacity-80">å·¥åˆ†: {points}</span>
                    </div>
                    </div>
                    <div className="text-lg font-serif tracking-widest font-bold">é‡åº†Â·1949</div>
                    <button onClick={() => setView('BACKPACK')} className="relative p-1">
                    <Package size={24} />
                    {inventory.length > 0 && <span className="absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full animate-ping"></span>}
                    </button>
                </div>

                <div className="flex-1 relative">
                    <MapView 
                    stages={stages} 
                    currentPos={currentPos} 
                    onStageClick={handleStageClick}
                    teamMembers={teamMembers}
                    />
                </div>

                {narrativeQueue && (
                    <NarrativePlayer 
                    script={narrativeQueue.content} 
                    onComplete={handleNarrativeComplete} 
                    />
                )}

                {currentTask && (
                    <TaskModule 
                    task={currentTask} 
                    onTaskComplete={handleTaskComplete} 
                    />
                )}

                <Modal 
                    isOpen={view === 'BACKPACK'} 
                    onClose={() => setView('HOME')} 
                    title="è¡Œå†›èƒŒå›Š"
                >
                    {inventory.length === 0 ? (
                    <div className="text-center py-8 text-stone-500 italic">èƒŒå›Šç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»å®Œæˆä»»åŠ¡å§ï¼</div>
                    ) : (
                    <div className="grid grid-cols-2 gap-3">
                        {inventory.map((item, idx) => (
                        <div key={idx} className="bg-stone-200 p-3 rounded border border-stone-300 flex flex-col items-center gap-2">
                            <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl shadow-inner ${item.type === 'medal' ? 'bg-red-200' : 'bg-yellow-100'}`}>
                            {item.type === 'medal' ? 'ğŸ–ï¸' : 'ğŸ«'}
                            </div>
                            <span className="font-bold text-sm text-stone-800">{item.name}</span>
                            <span className="text-[10px] bg-stone-300 px-1 rounded text-stone-600 uppercase">{item.type}</span>
                        </div>
                        ))}
                    </div>
                    )}
                </Modal>

                <div className="bg-[#fdfbf7] border-t border-stone-300 p-2 flex justify-around text-[10px] text-stone-500 z-20 pb-4">
                    <button className="flex flex-col items-center gap-1 text-red-800 font-bold">
                    <MapIcon size={20} />
                    <span>ä½œæˆ˜åœ°å›¾</span>
                    </button>
                    <button className="flex flex-col items-center gap-1">
                    <MessageSquare size={20} />
                    <span>æƒ…æŠ¥ç½‘</span>
                    </button>
                    <button className="flex flex-col items-center gap-1">
                    <User size={20} />
                    <span>æ¡£æ¡ˆ</span>
                    </button>
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RedJourneyApp />);
    </script>
</body>
</html>